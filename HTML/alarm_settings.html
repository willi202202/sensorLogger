<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Alarm-Settings</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, sans-serif;
            background: #f3f3f3;
            padding: 30px;
        }

        #container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.12);
        }

        h1 {
            margin-bottom: 30px;
            color: #333;
            text-align: center;
        }

        .alarm-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #fafafa;
        }

        .alarm-item.enabled {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .alarm-item.disabled {
            background: #ffebee;
            border-color: #f44336;
            opacity: 0.7;
        }

        .alarm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .alarm-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }

        .alarm-buttons {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn-enable {
            background: #4caf50;
            color: white;
        }

        .btn-enable:hover {
            background: #45a049;
        }

        .btn-disable {
            background: #f44336;
            color: white;
        }

        .btn-disable:hover {
            background: #da190b;
        }

        .btn-save {
            background: #2196f3;
            color: white;
        }

        .btn-save:hover {
            background: #0b7dda;
        }

        .alarm-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input[type="number"] {
            padding: 10px;
            border: 1px solid #bbb;
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .sensor-info {
            font-size: 0.85rem;
            color: #999;
            margin-top: 5px;
        }

        #message {
            text-align: center;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            display: none;
            font-weight: bold;
        }

        #message.success {
            background: #c8e6c9;
            color: #2e7d32;
            display: block;
        }

        #message.error {
            background: #ffcdd2;
            color: #c62828;
            display: block;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>‚öôÔ∏è Alarm-Settings</h1>
        <div id="message"></div>
        <div id="alarms-container"></div>
    </div>

    <script src="api.js"></script>
    <script>
        let alarmConfig = {};

        // JSON laden
        async function loadConfig() {
            try {
                console.log("üîÑ Versuche Config vom Backend zu laden...");
                
                // Nutze API.js f√ºr den Request
                const data = await API.get("/alarms");
                console.log("‚úÖ Config vom Backend geladen:", data);
                
                if (data.ok) {
                    alarmConfig = data.alarms;
                    renderAlarms();
                } else {
                    throw new Error("Backend Error: " + data.error);
                }
            } catch (error) {
                console.error("‚ùå Fehler beim Laden:", error);
                showMessage("Fehler beim Laden der Konfiguration: " + error.message, "error");
            }
        }

        function renderAlarms() {
            const container = document.getElementById("alarms-container");
            container.innerHTML = "";

            alarmConfig.enbutton.forEach((alarm, index) => {
                const isEnabled = alarm.default;
                const [minAlarm, maxAlarm] = alarm.default_alarm;

                const alarmItem = document.createElement("div");
                alarmItem.className = `alarm-item ${isEnabled ? "enabled" : "disabled"}`;
                alarmItem.id = `alarm-${index}`;

                alarmItem.innerHTML = `
                    <div class="alarm-header">
                        <div class="alarm-title">${alarm.button_title}</div>
                        <div class="alarm-buttons">
                            <button class="btn-enable" onclick="toggleAlarm(${index}, true)" ${isEnabled ? "style='opacity: 0.5; cursor: default;'" : ""}>‚úì Aktivieren</button>
                            <button class="btn-disable" onclick="toggleAlarm(${index}, false)" ${!isEnabled ? "style='opacity: 0.5; cursor: default;'" : ""}>‚úó Deaktivieren</button>
                        </div>
                    </div>

                    <div class="alarm-inputs">
                        <div class="input-group">
                            <label for="min-${index}">Minimum Alarm</label>
                            <input type="number" id="min-${index}" value="${minAlarm}" ${!isEnabled ? "disabled" : ""}>
                            <span class="sensor-info">Sensor: ${alarm.sensor_alias}</span>
                        </div>
                        <div class="input-group">
                            <label for="max-${index}">Maximum Alarm</label>
                            <input type="number" id="max-${index}" value="${maxAlarm}" ${!isEnabled ? "disabled" : ""}>
                        </div>
                    </div>

                    <button class="btn-save" onclick="saveAlarm(${index})">üíæ Speichern</button>
                `;

                container.appendChild(alarmItem);
            });
        }

        function toggleAlarm(index, enabled) {
            const alarm = alarmConfig.enbutton[index];
            alarm.default = enabled;

            const minInput = document.getElementById(`min-${index}`);
            const maxInput = document.getElementById(`max-${index}`);
            minInput.disabled = !enabled;
            maxInput.disabled = !enabled;

            const alarmItem = document.getElementById(`alarm-${index}`);
            alarmItem.className = `alarm-item ${enabled ? "enabled" : "disabled"}`;

            showMessage(`${alarm.button_title} wurde ${enabled ? "aktiviert" : "deaktiviert"}`, "success");
        }

        function saveAlarm(index) {
            const alarm = alarmConfig.enbutton[index];
            const minVal = parseInt(document.getElementById(`min-${index}`).value);
            const maxVal = parseInt(document.getElementById(`max-${index}`).value);

            if (isNaN(minVal) || isNaN(maxVal)) {
                showMessage("Fehler: Bitte g√ºltige Zahlen eingeben", "error");
                return;
            }

            if (minVal >= maxVal) {
                showMessage("Fehler: Minimum muss kleiner als Maximum sein", "error");
                return;
            }

            alarm.default_alarm = [minVal, maxVal];
            showMessage(`‚úì ${alarm.button_title} gespeichert: [${minVal}, ${maxVal}]`, "success");
            
            // Sende √Ñnderung zum Backend
            saveToBackend();
        }

        async function saveToBackend() {
            try {
                console.log("üì§ Sende Config zum Backend");
                const data = await API.post("/alarms", alarmConfig);
                console.log("Backend Response:", data);
                
                if (data.ok) {
                    console.log("‚úÖ Backend aktualisiert");
                } else {
                    showMessage("Fehler beim Speichern: " + data.error, "error");
                }
            } catch (error) {
                console.error("Fehler beim Senden zum Backend:", error);
                showMessage("Fehler beim Speichern zum Backend", "error");
            }
        }

        function showMessage(text, type) {
            const msg = document.getElementById("message");
            msg.textContent = text;
            msg.className = type;
            setTimeout(() => {
                msg.className = "";
            }, 3000);
        }

        // Init
        loadConfig();
    </script>
</body>
</html>
